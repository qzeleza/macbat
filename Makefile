# Makefile –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–¥—É–ª—è –±–∞—Ç–∞—Ä–µ–∏ MacBat
# –†–ê–ë–û–ß–ê–Ø –í–ï–†–°–ò–Ø - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å test_*.go

.PHONY: all build run test test-fixed test-unit test-coverage test-bench test-race \
	test-memory test-threading test-debug test-specific check-test-files \
	setup-links cleanup-links rename-to-standard restore-from-standard \
	lint fmt vet deps clean clean-build quick dev info help

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
PACKAGE = ./...
COVERAGE_FILE = coverage.out
COVERAGE_HTML = coverage.html

# --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–±–æ—Ä–∫–∏ ---
BINARY_NAME=macbat
MAIN_PATH=./cmd/macbat

# –§–∞–π–ª —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –∞–≤—Ç–æ-–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞ –Ω–æ–º–µ—Ä–∞ —Å–±–æ—Ä–∫–∏
BUILD_SCRIPT = ./scripts/update_build_number.sh

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä—Å–∏–∏, –ø–æ–ª—É—á–∞–µ–º–∞—è –∏–∑ Git.
# –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥. –ï—Å–ª–∏ —Ç–µ–≥–æ–≤ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 'dev'.
VERSION ?= $(shell git describe --tags --abbrev=0 2>/dev/null || echo "dev")
COMMIT_HASH ?= $(shell git rev-parse --short HEAD)
BUILD_DATE ?= $(shell date -u +'%Y-%m-%dT%H:%M:%SZ')

# –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä —Å–±–æ—Ä–∫–∏ (—Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å—á—ë—Ç—á–∏–∫)
BUILD_NUMBER := $(shell bash $(BUILD_SCRIPT) $(VERSION))
# –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä —Å–±–æ—Ä–∫–∏ –∫ –≤–µ—Ä—Å–∏–∏
VERSION := $(VERSION)+$(BUILD_NUMBER)

# –ü—É—Ç—å –º–æ–¥—É–ª—è
MODULE_PATH = github.com/qzeleza/macbat

# –§–ª–∞–≥–∏ –∫–æ–º–ø–æ–Ω–æ–≤—â–∏–∫–∞ –¥–ª—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–µ—Ä—Å–∏–∏ –≤ –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª.
LDFLAGS = -ldflags="\
    -X '$(MODULE_PATH)/internal/version.Version=$(VERSION)' \
    -X '$(MODULE_PATH)/internal/version.CommitHash=$(COMMIT_HASH)' \
    -X '$(MODULE_PATH)/internal/version.BuildDate=$(BUILD_DATE)' \
    -X '$(MODULE_PATH)/internal/version.BuildNumber=$(BUILD_NUMBER)'"

# –ù–∞—Ö–æ–¥–∏–º —Ñ–∞–π–ª—ã test_*.go
TEST_PREFIX_FILES = $(shell find . -name "test_*.go" -type f)

# –¶–≤–µ—Ç–∞
GREEN = \033[32m
YELLOW = \033[33m
RED = \033[31m
BLUE = \033[34m
NC = \033[0m

all: test

# --- –¶–µ–ª–∏ –¥–ª—è —Å–±–æ—Ä–∫–∏ ---
# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ GitHub ---
REPO          = qzeleza/macbat          # owner/repo –Ω–∞ GitHub
GH            ?= gh                     # GitHub CLI
RELEASE_TITLE ?= "MacBat $(VERSION)"

# –¶–µ–ª—å: publish ‚Äì –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Ä–µ–ª–∏–∑–∞ –Ω–∞ GitHub
# 1. –°–±–æ—Ä–∫–∞ —Ä–µ–ª–∏–∑–Ω–æ–≥–æ –±–∏–Ω–∞—Ä–Ω–∏–∫–∞ (make release)
# 2. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–≥–∞ –≤–µ—Ä—Å–∏–∏ –∏ –ø—É—à –≤ origin
# 3. –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞ —á–µ—Ä–µ–∑ gh cli –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –±–∏–Ω–∞—Ä–Ω–∏–∫–∞
# 4. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ tar.gz –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤, –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ sha256
# 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Homebrew formula macbat.rb (version + sha256)
# 6. –ö–æ–º–º–∏—Ç formula –∏ –ø—É—à –≤ origin
# –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω GitHub CLI (`gh`) –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è GH_TOKEN —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.
publish: release ## –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ª–∏–∑, –≤—ã–ª–æ–∂–∏—Ç—å –Ω–∞ GitHub –∏ –æ–±–Ω–æ–≤–∏—Ç—å Homebrew formula
    @echo "$(YELLOW)‚ñ∂Ô∏è  –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Ä–µ–ª–∏–∑–∞ $(VERSION)$(NC)"
    @if ! $(GH) auth status >/dev/null 2>&1; then \
        echo "$(RED)üîë GH CLI –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –í—ã–ø–æ–ª–Ω–∏—Ç–µ 'gh auth login' –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ GH_TOKEN$(NC)"; exit 1; fi
    # --- Git tag ---
    @git tag -a $(VERSION) -m "–ü—É–±–ª–∏–∫–∞—Ü–∏—è —Ä–µ–ª–∏–∑–∞ $(VERSION)" || true
    @git push origin $(VERSION)
    # --- GitHub release ---
    $(GH) release create $(VERSION) ./$(BINARY_NAME) \
      --repo $(REPO) \
      --title $(RELEASE_TITLE) \
      --notes "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–ª–∏–∑ $(VERSION), build $(BUILD_NUMBER)"
    # --- Source tarball & sha256 ---
    @git archive --format=tar.gz --prefix=macbat-$(VERSION)/ $(VERSION) -o macbat-$(VERSION).tar.gz
    @SHA=$$(shasum -a 256 macbat-$(VERSION).tar.gz | awk '{print $$1}'); \
        sed -i '' -e "s/^  url \\".*\\"/  url \"https:\/\/github.com\/$(REPO)\/archive\/refs\/tags\/$(VERSION).tar.gz\"/" macbat.rb; \
        sed -i '' -e "s/^  version \".*\"/  version \"$(VERSION)\"/" macbat.rb; \
        sed -i '' -e "s/^  sha256 \".*\"/  sha256 \"$$SHA\"/" macbat.rb; \
        echo "$(GREEN)–§–æ—Ä–º—É–ª–∞ macbat.rb –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (sha256=$$SHA)$(NC)";
    # --- Commit formula ---
    @git add macbat.rb
    @git commit -m "brew formula: update to $(VERSION) ($$SHA)" || true
    @git push origin HEAD
    @echo "$(GREEN)‚úÖ –†–µ–ª–∏–∑ $(VERSION) –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω$(NC)"

build: ## –°–æ–±—Ä–∞—Ç—å –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤–µ—Ä—Å–∏–∏
	@echo "$(GREEN)–°–±–æ—Ä–∫–∞ $(BINARY_NAME)...$(NC)"
	@echo "  –í–µ—Ä—Å–∏—è: $(VERSION)"
	@echo "  –ö–æ–º–º–∏—Ç: $(COMMIT_HASH)"
	@echo "  –î–∞—Ç–∞: $(BUILD_DATE)"
	@echo "  –ù–æ–º–µ—Ä —Å–±–æ—Ä–∫–∏: $(BUILD_NUMBER)"
	CGO_ENABLED=1 go build $(LDFLAGS) -o $(BINARY_NAME) $(MAIN_PATH)
	@echo "$(GREEN)–°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ./$(BINARY_NAME)$(NC)"

run: build ## –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
	@echo "$(YELLOW)–£–¥–∞–ª—è–µ–º –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã $(BINARY_NAME)...$(NC)"
	killall $(BINARY_NAME) 2>/dev/null || true
	@echo "$(GREEN)–ó–∞–ø—É—Å–∫ $(BINARY_NAME) –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏...$(NC)"
	./$(BINARY_NAME)
	@echo "$(CYAN)–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:$(NC)"
	./$(BINARY_NAME) --log 
	@echo "$(CYAN)–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:$(NC)"
	ps -ax | grep -v grep | grep '/$(BINARY_NAME)' --color=always

release: clean
	@echo "$(YELLOW)–°–±–æ—Ä–∫–∞ $(BINARY_NAME) –¥–ª—è —Ä–µ–ª–∏–∑–∞...$(NC)"
	CGO_ENABLED=1 go build -ldflags "$(LDFLAGS)" -o $(BINARY_NAME) ./cmd/$(BINARY_NAME)
	@echo "$(GREEN)–°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ./$(BINARY_NAME)$(NC)"

install: clean release
	@echo "$(YELLOW)–£—Å—Ç–∞–Ω–æ–≤–∫–∞ $(BINARY_NAME) –≤ /usr/local/bin...$(NC)"
	@cp ./$(BINARY_NAME) /usr/local/bin/
	@echo "$(GREEN)–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.$(NC)"

clean-build: ## –£–¥–∞–ª–∏—Ç—å —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª
	@echo "$(YELLOW)–û—á–∏—Å—Ç–∫–∞ —Å–±–æ—Ä–∫–∏...$(NC)"
	@rm -f $(BINARY_NAME)
	@echo "$(GREEN)–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.$(NC)"

help: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
    @echo "$(GREEN)MacBat Makefile$(NC)"
    @echo ""
    # –ê–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏
    @grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
        awk 'BEGIN {FS=":.*?## "}; {printf "  $(GREEN)%-20s$(NC) %s\n", $$1, $$2}'
    @echo ""
    @echo "$(CYAN)–ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ü–µ–ª–∏:$(NC)"
    @echo "  $(GREEN)make run$(NC)       ‚Äì —Å–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
    @echo "  $(GREEN)make release$(NC)   ‚Äì —Å–±–æ—Ä–∫–∞ —Ä–µ–ª–∏–∑–Ω–æ–≥–æ –±–∏–Ω–∞—Ä–Ω–∏–∫–∞"
    @echo "  $(GREEN)make install$(NC)   ‚Äì —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∏–Ω–∞—Ä–Ω–∏–∫–∞ –≤ /usr/local/bin"
    @echo "  $(GREEN)make clean$(NC)     ‚Äì –ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤"
    @echo "  $(GREEN)make test$(NC)      ‚Äì –∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤"
    @echo "  $(GREEN)make info$(NC)      ‚Äì –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ"
	@echo ""
	@echo "$(CYAN)–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ü–µ–ª–∏:$(NC)"
	@echo "  $(GREEN)make deps$(NC)      ‚Äì —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
	@echo "  $(GREEN)make quick$(NC)     ‚Äì –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞"
	@echo "  $(GREEN)make dev$(NC)       ‚Äì —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞"
	@echo "  $(GREEN)make fmt$(NC)       ‚Äì —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞"
	@echo "  $(GREEN)make vet$(NC)       ‚Äì –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞"
	@echo "  $(GREEN)make test-fixed$(NC) ‚Äì –∑–∞–ø—É—Å–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤"
	@echo "  $(GREEN)make test-unit$(NC)  ‚Äì –∑–∞–ø—É—Å–∫ unit —Ç–µ—Å—Ç–æ–≤"
	@echo "  $(GREEN)make test-coverage$(NC) ‚Äì —Ç–µ—Å—Ç—ã —Å –æ—Ç—á–µ—Ç–æ–º –æ –ø–æ–∫—Ä—ã—Ç–∏–∏"
	@echo "  $(GREEN)make test-race$(NC)   ‚Äì —Ç–µ—Å—Ç—ã —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≥–æ–Ω–æ–∫"
	@echo "  $(GREEN)make test-specific TEST=X$(NC) ‚Äì –∑–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞"
	@echo ""
	@echo "$(CYAN)–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ü–µ–ª–∏:$(NC)"
	@echo "  $(GREEN)make profile-cpu$(NC) ‚Äì CPU –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ"
	@echo "  $(GREEN)make profile-mem$(NC) ‚Äì –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏"


# –£–¢–ò–õ–ò–¢–´
clean: clean-build cleanup-links ## –û—á–∏—Å—Ç–∫–∞
	@rm -f $(COVERAGE_FILE) $(COVERAGE_HTML) *.prof
	@rm -rf .makefile_backup .makefile_links
	@go clean -testcache

deps: ## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
	@go mod download && go mod tidy

quick: fmt vet test ## –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

dev: quick test-race ## –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

info: ## –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ
	@echo "$(GREEN)MacBat –ø—Ä–æ–µ–∫—Ç:$(NC)"
	@echo "  Go: $$(go version | awk '{print $$3}')"
	@echo "  –§–∞–π–ª—ã test_*.go: $(shell echo '$(TEST_PREFIX_FILES)' | wc -w)"
	@echo "  –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ *_test.go: $(shell find . -name '*_test.go' | wc -l)"
	@if [ -n "$(TEST_PREFIX_FILES)" ]; then \
		total=0; \
		for file in $(TEST_PREFIX_FILES); do \
			count=$$(grep -c '^func Test' $$file 2>/dev/null || echo 0); \
			total=$$((total + count)); \
		done; \
		echo "  –§—É–Ω–∫—Ü–∏–π Test*: $$total"; \
	fi




# –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø
test: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã (—á–µ—Ä–µ–∑ —Å—Å—ã–ª–∫–∏)
	@echo "$(GREEN)–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –∏–∑ —Ñ–∞–π–ª–æ–≤ test_*.go...$(NC)"
	@if [ -n "$(TEST_PREFIX_FILES)" ]; then \
		$(MAKE) setup-links; \
		echo "$(GREEN)–ó–∞–ø—É—Å–∫ go test...$(NC)"; \
		go test -v $(PACKAGE) -short || true; \
		$(MAKE) cleanup-links; \
	else \
		echo "$(YELLOW)–§–∞–π–ª—ã test_*.go –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∑–∞–ø—É—Å–∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤$(NC)"; \
		go test -v $(PACKAGE) -short; \
	fi

test-fixed: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
	@echo "$(GREEN)–ó–∞–ø—É—Å–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤...$(NC)"
	@if [ -n "$(TEST_PREFIX_FILES)" ]; then \
		$(MAKE) setup-links; \
		go test -v $(PACKAGE) -short -run ".*Fixed.*|.*Stable.*|.*Robust.*" || true; \
		$(MAKE) cleanup-links; \
	else \
		go test -v $(PACKAGE) -short -run ".*Fixed.*|.*Stable.*|.*Robust.*"; \
	fi

test-unit: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å unit —Ç–µ—Å—Ç—ã
	@echo "$(GREEN)Unit —Ç–µ—Å—Ç—ã...$(NC)"
	@$(MAKE) test

test-coverage: ## –¢–µ—Å—Ç—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∫–æ–¥–∞
	@echo "$(GREEN)–¢–µ—Å—Ç—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º...$(NC)"
	@if [ -n "$(TEST_PREFIX_FILES)" ]; then \
		$(MAKE) setup-links; \
		go test -v $(PACKAGE) -short -coverprofile=$(COVERAGE_FILE) -covermode=atomic || true; \
		if [ -f $(COVERAGE_FILE) ]; then \
			go tool cover -html=$(COVERAGE_FILE) -o $(COVERAGE_HTML); \
			echo "$(GREEN)–û—Ç—á–µ—Ç: $(COVERAGE_HTML)$(NC)"; \
			go tool cover -func=$(COVERAGE_FILE) | tail -n 1; \
		fi; \
		$(MAKE) cleanup-links; \
	else \
		go test -v $(PACKAGE) -short -coverprofile=$(COVERAGE_FILE) -covermode=atomic; \
	fi

test-bench: ## –ë–µ–Ω—á–º–∞—Ä–∫–∏
	@echo "$(GREEN)–ë–µ–Ω—á–º–∞—Ä–∫–∏...$(NC)"
	@if [ -n "$(TEST_PREFIX_FILES)" ]; then \
		$(MAKE) setup-links; \
		go test -v $(PACKAGE) -short -bench=. -benchmem || true; \
		$(MAKE) cleanup-links; \
	else \
		go test -v $(PACKAGE) -short -bench=. -benchmem; \
	fi

test-race: ## –¢–µ—Å—Ç—ã —Å –¥–µ—Ç–µ–∫—Ç–æ—Ä–æ–º –≥–æ–Ω–æ–∫
	@echo "$(GREEN)–î–µ—Ç–µ–∫—Ç–æ—Ä –≥–æ–Ω–æ–∫...$(NC)"
	@if [ -n "$(TEST_PREFIX_FILES)" ]; then \
		$(MAKE) setup-links; \
		go test -v $(PACKAGE) -short -race || true; \
		$(MAKE) cleanup-links; \
	else \
		go test -v $(PACKAGE) -short -race; \
	fi

test-memory: ## –¢–µ—Å—Ç—ã –ø–∞–º—è—Ç–∏
	@echo "$(GREEN)–¢–µ—Å—Ç—ã –ø–∞–º—è—Ç–∏...$(NC)"
	@if [ -n "$(TEST_PREFIX_FILES)" ]; then \
		$(MAKE) setup-links; \
		go test -v $(PACKAGE) -short -run ".*Memory.*" || true; \
		$(MAKE) cleanup-links; \
	else \
		go test -v $(PACKAGE) -short -run ".*Memory.*"; \
	fi

test-threading: ## –¢–µ—Å—Ç—ã –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏
	@echo "$(GREEN)–¢–µ—Å—Ç—ã –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏...$(NC)"
	@if [ -n "$(TEST_PREFIX_FILES)" ]; then \
		$(MAKE) setup-links; \
		go test -v $(PACKAGE) -short -run ".*Thread.*|.*Concurrent.*" || true; \
		$(MAKE) cleanup-links; \
	else \
		go test -v $(PACKAGE) -short -run ".*Thread.*|.*Concurrent.*"; \
	fi

test-debug: ## –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –∑–∞–ø—É—Å–∫
	@echo "$(GREEN)–û—Ç–ª–∞–¥–∫–∞...$(NC)"
	@if [ -n "$(TEST_PREFIX_FILES)" ]; then \
		$(MAKE) setup-links; \
		go test -v $(PACKAGE) -short -count=1 || true; \
		$(MAKE) cleanup-links; \
	else \
		go test -v $(PACKAGE) -short -count=1; \
	fi

test-specific: ## –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–µ—Å—Ç (make test-specific TEST=TestName)
	@if [ -z "$(TEST)" ]; then \
		echo "$(RED)–£–∫–∞–∂–∏—Ç–µ TEST=TestName$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞: $(TEST)$(NC)"
	@if [ -n "$(TEST_PREFIX_FILES)" ]; then \
		$(MAKE) setup-links; \
		go test -v $(PACKAGE) -short -run "$(TEST)" || true; \
		$(MAKE) cleanup-links; \
	else \
		go test -v $(PACKAGE) -short -run "$(TEST)"; \
	fi

test-list: ## –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
	@echo "$(GREEN)–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ—Å—Ç—ã:$(NC)"
	@if [ -n "$(TEST_PREFIX_FILES)" ]; then \
		for file in $(TEST_PREFIX_FILES); do \
			echo "$(YELLOW)$$file:$(NC)"; \
			grep '^func Test' $$file | awk '{print $$2}' | cut -d'(' -f1 | sed 's/^/  /' || true; \
		done; \
	else \
		echo "$(YELLOW)–§–∞–π–ª—ã test_*.go –Ω–µ –Ω–∞–π–¥–µ–Ω—ã$(NC)"; \
	fi

# –ö–ê–ß–ï–°–¢–í–û –ö–û–î–ê
lint: ## –õ–∏–Ω—Ç–µ—Ä
	@if command -v golangci-lint >/dev/null 2>&1; then \
		golangci-lint run; \
	else \
		go vet $(PACKAGE); \
	fi

fmt: ## –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
	@go fmt $(PACKAGE)

vet: ## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞  
	@go vet $(PACKAGE)


.DEFAULT_GOAL := help